**Packages et librairies**

```{r include=FALSE}
packages <- c(
  "archive",
  "arrow",
  "aws.s3",
  "corrplot",
  "data.table",
  "ggplot2",
  "httr",
  "mapview",
  "plm",
  "sf",
  "stargazer",
  "viridis",
  "xtable")

installed_packages <- packages %in% rownames(installed.packages())
if (any(installed_packages == FALSE)) {
  install.packages(packages[!installed_packages])
}

invisible(lapply(packages, library, character.only = TRUE))

rm(installed_packages, packages)
```

**Répertoires**

```{r}
if (!dir.exists("data_main")) {dir.create("data_main")}
if (!dir.exists("output")) {dir.create("output")}
```

**Fonctions**

```{r}
# Pour charger les données Parquet
load_parquet <- function(filename) {
  local_filepath <- file.path("data_main/", filename)
  
  if (file.exists(local_filepath)) {
    message("Loading ", filename, " from local directory")
    data <- arrow::read_parquet(local_filepath)
    data <- as.data.table(data)
    return(data)
    
  } else {
    message("Downloading ", filename, " from SSP Cloud")
    tryCatch({
        s3_filepath <- file.path("/diffusion", filename)
        data <- aws.s3::s3read_using(
            FUN = arrow::read_parquet,
            object = s3_filepath,
            bucket = "maeldieudonne",
            opts = list("region" = ""))
        data <- as.data.table(data)
        return(data)
    }, error = function(e) {
      custom_message <- paste("Failed to download", filename, "from SSP cloud.")
      message(custom_message)
      stop(custom_message)})
  }
}

# Pour charger les données Shapefile
load_shapefile <- function(filename) {
  local_filepath <- paste0("data_other/shapefile/", filename)
  
  if (file.exists(local_filepath)) {
    message("Loading from local directory")
    data <- sf::st_read(local_filepath)
    return(data)
    
  } else {
    message("Downloading from SSP cloud")
    if (!dir.exists("data_other/shapefile")) {dir.create("data_other/shapefile")}
    tryCatch({
      aws.s3::s3sync(
        path = "data_other/shapefile",
        bucket = "maeldieudonne",
        region = "",
        prefix = "diffusion/shapefile/",
        direction = c("upload", "download"),
        multipart = TRUE,
        create = TRUE)
      data <- sf::st_read(local_filepath)
      return(data)
    }, error = function(e) {
      custom_message <- paste("Failed to download", filename, "from SSP cloud.")
      message(custom_message)
      stop(custom_message)})
  }
}
  
# Pour formater les nombres dans les tableaux
round_and_remove_zeros <- function(x) {
  if (is.numeric(x)) {
    rounded_value <- round(x, digits = 3)
    result <- ifelse(rounded_value != 0, gsub("\\.?0+$", "", as.character(rounded_value)), "0")
    return(result)} 
  else {return(x)}
}

# Pour générer des abréviations
get_first_letters <- function(input_string) {
  words <- unlist(strsplit(input_string, " |-"))
  if (length(words) == 1) {first_letters <- substr(words, 1, 3)} 
  else {first_letters <- substr(words, 1, 1)}
  paste(first_letters, collapse = "")
}
```
