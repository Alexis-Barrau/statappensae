**Construction de la base**

```{r}
codes_regions <- fread("data_other/codes_regions_Insee.csv", header = TRUE)
codes_regions$ABRV <- sapply(codes_regions$LIBELLE, get_first_letters)

# Contours des départements
background_province <- load_shapefile("COMMUNE.shx")
map_data_province <- merge(background_province, subset(pres1981, dep != 75), by.x = "INSEE_COM", by.y = "codecommune", all.x = TRUE)
map_data_province <- subset(map_data_province, select = -c(INSEE_ARR, INSEE_CAN, INSEE_DEP, SIREN_EPCI, STATUT))

# Contour des arrondissements
background_plm <- load_shapefile("ARRONDISSEMENT_MUNICIPAL.shx")
## Ajout du code région
background_plm$INSEE_REG <- ifelse(startsWith(background_plm$INSEE_COM, "13"), 93,
                                    ifelse(startsWith(background_plm$INSEE_COM, "69"), 84,
                                           ifelse(startsWith(background_plm$INSEE_COM, "75"), 11, NA)))

# Fusion pour les arrondissements parisiens
map_data_paris <- merge(background_plm, subset(pres1981, dep == 75), by.x = "INSEE_ARM", by.y = "codecommune", all.x = TRUE)
map_data_paris <- subset(map_data_paris, select = -INSEE_ARM)

# Fusion globale et nettoyage
map_data <- rbind(map_data_province, map_data_paris)
st_crs(map_data) <- 9794
rm(background_province, map_data_province, background_plm, map_data_paris)
```

**Cartes statiques**

```{r}
# Carte statique avec ggplot, réduite à une région, à résolution paramétrable
## Se référer à la base code_region pour connaître les numéros de régions

mapped_var <- "part"
mapped_var_name <- "Participation"
selected_reg <- "53"

subset_map_data <- map_data[map_data$INSEE_REG == selected_reg, ]
subset_map_data[[mapped_var]] <- round(subset_map_data[[mapped_var]], 2)
reg_name <- codes_regions$LIBELLE[codes_regions$REG == selected_reg]
reg_abrv <- codes_regions$ABRV[codes_regions$REG == selected_reg]

title <- paste0(mapped_var_name, "\nPremier tour des élections présidentielles\n", reg_name, ", 1981")
output_file <- paste0("output/", mapped_var, "_1981_", reg_abrv, ".png")

# Calcul des dimensions de la carte
bbox <- st_bbox(subset_map_data)
aspect_ratio <- diff(c(bbox$xmin, bbox$xmax)) / diff(c(bbox$ymin, bbox$ymax))
base_width <- 7 # Paramètre définissant la résolution
base_height <- base_width / aspect_ratio
font_size <- base_width * 2.2

# Génération de la carte
plot <- ggplot() +
  geom_sf(data = subset_map_data, aes(fill = .data[[mapped_var]])) +
  scale_fill_viridis_c(name = mapped_var_name, labels = scales::percent_format(scale = 100)) +
  ggtitle(paste(title)) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = font_size),
        axis.text = element_blank(),
        panel.grid = element_blank(),
        plot.title.position = "plot",
        legend.title = element_text(size = font_size * 0.8),
        legend.text = element_text(size = font_size * 0.7))

# Enregistrement et nettoyage
ggsave(output_file, plot = plot, width = base_width, height = base_height, units = "in")
rm(bbox, aspect_ratio, base_height, base_width, font_size, mapped_var, mapped_var_name, reg_abrv, reg_name, output_file, selected_reg, subset_map_data, title)
```

```{r}
# Carte statique avec ggplot, France entière, à résolution paramétrable

mapped_var <- "part"
mapped_var_name <- "Participation"

title <- paste0(mapped_var_name, "\nPremier tour des élections présidentielles\n1981")
output_file <- paste0("output/", mapped_var, "_1981_France.png")
map_data[[mapped_var]] <- round(map_data[[mapped_var]], 2)

# Calcul des dimensions de la carte
bbox <- st_bbox(map_data)
aspect_ratio <- diff(c(bbox$xmin, bbox$xmax)) / diff(c(bbox$ymin, bbox$ymax))
base_width <- 7 # Paramètre définissant la résolution
base_height <- base_width / aspect_ratio
font_size <- base_width * 2.2

# Génération de la carte
plot <- ggplot() +
  geom_sf(data = map_data, aes(fill = .data[[mapped_var]])) +
  scale_fill_viridis_c(name = mapped_var_name, labels = scales::percent_format(scale = 100)) +
  ggtitle(paste(title)) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = font_size),
        axis.text = element_blank(),
        panel.grid = element_blank(),
        plot.title.position = "plot",
        legend.title = element_text(size = font_size * 0.8),
        legend.text = element_text(size = font_size * 0.7))

# Enregistrement et nettoyage
ggsave(output_file, plot = plot, width = base_width, height = base_height, units = "in")
rm(aspect_ratio, base_height, base_width, bbox, font_size, mapped_var, mapped_var_name, plot)
```

**Cartes dynamiques**

```{r}
# Carte dynamique avec mapview, réduite à un département (les détails s'affichent en cliquant sur une commune).
subset_map_data <- map_data[map_data$dep == "2A", ]
subset_map_data$rounded_part <- paste0(round(100 * subset_map_data$part, digits = 2), " %")

popup_content <- paste("<strong>Commune</strong>", subset_map_data$NOM, sep = "<br>",
                       "<strong>Participation</strong>", subset_map_data$rounded_part, ""
                       )

mapview(subset_map_data, zcol = "rounded_part", popup = popup_content, layer.name = "Participation T1 1981")

rm(subset_map_data, popup_content)
```

```{r}
# Carte dynamique avec mapview (les détails s'affichent en cliquant sur une commune).
# Ne parvient jamais à se charger complètement, demande trop de ressources ?
map_data$rounded_part <- paste0(round(100 * map_data$part, digits = 2), " %")

popup_content <- paste("<strong>Commune</strong>", map_data$NOM, sep = "<br>",
                       "<strong>Participation</strong>", map_data$rounded_part, ""
                       )

mapview(map_data, zcol = "rounded_part", popup = popup_content, layer.name = "Participation T1 1981")

rm(subset_map_data, popup_content)
```
