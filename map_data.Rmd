---
title: "map_data"
output: html_document
date: "2024-01-29"
---

```{r}
# Téléchargement du fond de carte.
# Le serveur est très lent, d'où le timeout. Si nous faisons beaucoup de cartes, il faudra plutôt déposer les fichiers sur le bucket.
if (!dir.exists("shapefile")) {dir.create("shapefile")}
httr::GET("https://wxs.ign.fr/x02uy2aiwjo9bm8ce5plwqmr/telechargement/prepackage/ADMINEXPRESS_SHP_TERRITOIRES_PACK_2023-12-19$ADMIN-EXPRESS_3-2__SHP_LAMB93_FXX_2023-12-19/file/ADMIN-EXPRESS_3-2__SHP_LAMB93_FXX_2023-12-19.7z", timeout(1800), progress(), write_disk("shapefile/Carto_Insee.7z", overwrite = TRUE))

# Extraction
# Code à compléter pour extraire aussi les fichiers ARRONDISSEMENT_MUNICIPAL
extensions <- c("shp", "shx", "dbf")
files_to_extract <- paste0("ADMIN-EXPRESS_3-2__SHP_LAMB93_FXX_2023-12-19/ADMIN-EXPRESS/1_DONNEES_LIVRAISON_2023-12-00156/ADE_3-2_SHP_LAMB93_FXX-ED2023-12-19/COMMUNE.", extensions)
archive_extract("shapefile/Carto_Insee.7z", dir = "shapefile", files = files_to_extract)
unlink("shapefile/Carto_Insee.7z")

# Nettoyage
base_path <- file.path("shapefile", "ADMIN-EXPRESS_3-2__SHP_LAMB93_FXX_2023-12-19", "ADMIN-EXPRESS", "1_DONNEES_LIVRAISON_2023-12-00156", "ADE_3-2_SHP_LAMB93_FXX-ED2023-12-19")
for (ext in extensions) {
  source_file <- file.path(base_path, paste("COMMUNE", ext, sep = "."))
  target_file <- file.path("shapefile", paste("COMMUNE", ext, sep = "."))
  file.rename(source_file, target_file)
}
unlink(base_path, recursive = TRUE)
rm(extensions, files_to_extract, base_path)
unlink("shapefile/ADMIN-EXPRESS_3-2__SHP_LAMB93_FXX_2023-12-19", recursive = TRUE)
```

```{r}
# Construction de la base
background_province <- st_read("shapefile/COMMUNE.shx")
map_data_province <- merge(background_province, subset(pres1981, dep != 75), by.x = "INSEE_COM", by.y = "codecommune", all.x = TRUE)

map_data_province <- subset(map_data_province, select = -c(INSEE_ARR, INSEE_CAN, INSEE_DEP, INSEE_REG, SIREN_EPCI, STATUT))

background_paris <- st_read("shapefile/ARRONDISSEMENT_MUNICIPAL.shx")
map_data_paris <- merge(background_paris, subset(pres1981, dep == 75), by.x = "INSEE_ARM", by.y = "codecommune", all.x = TRUE)

map_data_paris <- subset(map_data_paris, select = -INSEE_ARM)

map_data <- rbind(map_data_province, map_data_paris)
st_crs(map_data) <- 9794
```

```{r}
# Carte statique
ggplot() +
  geom_sf(data = map_data, aes(fill = part)) +
  scale_fill_viridis_c(name = "Part") +
  ggtitle("Participation au premier tour des élections présidentielles, 1981") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
# Carte dynamique avec mapview, réduite à un département pour améliorer la lisibilité et accélérer le rendu (les détails s'affichent en cliquant sur une commune).

subset_map_data <- map_data[map_data$dep == "2A", ]

subset_map_data$rounded_part <- paste0(round(100 * subset_map_data$part, digits = 2), " %")

popup_content <- paste("<strong>Commune</strong>", subset_map_data$NOM, sep = "<br>",
                       "<strong>Participation</strong>", subset_map_data$rounded_part, ""
                       )

mapview(subset_map_data, zcol = "rounded_part", popup = popup_content, layer.name = "Participation T1 1981")
```

```{r}
# Carte dynamique avec mapview (les détails s'affichent en cliquant sur une commune).

map_data$rounded_part <- paste0(round(100 * map_data$part, digits = 2), " %")

popup_content <- paste("<strong>Commune</strong>", map_data$NOM, sep = "<br>",
                       "<strong>Participation</strong>", map_data$rounded_part, ""
                       )

mapview(map_data, zcol = "rounded_part", popup = popup_content, layer.name = "Participation T1 1981")
```
