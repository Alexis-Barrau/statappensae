---
title: "analyze_data"
output: html_document
date: "2024-01-26"
---

```{r}
# Optionnel, pour charger la base si déjà enregistrée.
# pres1981 <- read_feather("data/pres1981.feather")
```


# Analyses descriptives


```{r}
# Analyse des NaN
columns <- names(pres1981)[names(pres1981) != "pop1981"]

na_pop <- list()
na_count <- list()

for (col in columns) {
  na_count[[col]] <- sum(is.na(pres1981[[col]]))
  na_pop[[col]] <- pres1981[is.na(get(col)), sum(pop1981, na.rm = TRUE)]
}

na_pop <- data.table(variable = names(na_pop), missing_pop = unlist(na_pop))
na_count <- data.table(variable = names(na_count), missing_communes = unlist(na_count))

nan_results <- merge(na_pop, na_count, by = "variable")

nb_communes <- uniqueN(pres1981, by = "codecommune")
nan_results[, prop_missing_communes := missing_communes / nb_communes]

pop_tot_1981 <- sum(pres1981$pop1981, na.rm = TRUE)
nan_results[, prop_missing_pop := missing_pop / pop_tot_1981]

print(nan_results)
print(xtable(nan_results, type = "latex"), file = "output/nan_results.tex")

rm(columns, na_pop, na_count)
```

```{r}
# Calcul du taux national de propriétaires
propri_tot <- data.table(year = numeric(), sum_npropri = numeric(), sum_nlogement = numeric(), prop_ratio = numeric())
for (year in 1960:2022) {
  col_npropri <- paste0("npropri", year)
  col_nlogement <- paste0("nlogement", year)
  sum_npropri <- sum(propri[[col_npropri]], na.rm = TRUE)
  sum_nlogement <- sum(propri[[col_nlogement]], na.rm = TRUE)
  prop_ratio <- sum_npropri / sum_nlogement
  propri_tot <- rbind(propri_tot, data.table(year = year, sum_npropri = sum_npropri, sum_nlogement = sum_nlogement, prop_ratio = prop_ratio))
}
rm(col_npropri, col_nlogement, sum_npropri, sum_nlogement, prop_ratio, year)

# Graph
ggplot(propri_tot, aes(x = year, y = prop_ratio)) +
  geom_line(color = "skyblue") +
  geom_point(color = "skyblue") +
  labs(title = "Taux de propriétaires, 1960-2022",
       x = "Années",
       y = "Taux de propriétaires") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))
rm(propri_tot)
```


# Régressions


```{r}
dependent_variable <- "part"
excluded_covariables <- c("dep", "codecommune", "plm", "abs", "nulsT2", "absT2", "codecommune2", "dep2", "part", "partT2", "GD_ratio_T1", "GD_ratio_T2", "lib_ratio_T1")
regression_formula <- as.formula(paste(dependent_variable, "~", paste(setdiff(names(pres1981), excluded_covariables), collapse = "+")))
model <- lm(regression_formula, data = pres1981)
summary(model)

prop_missing_communes_1981 <- 100 * sum(apply(pres1981[, !excluded_covariables, with = FALSE], 1, function(row) any(is.na(row)))) / nb_communes
rows_with_nan <- pres1981[apply(pres1981[, !excluded_covariables, with = FALSE], 1, function(row) any(is.na(row))), ]
prop_missing_pop_1981 <- 100 * sum(rows_with_nan$pop1981, na.rm = TRUE) / pop_tot_1981
cat("Les valeurs manquantes représentent", prop_missing_communes_1981, "% des communes et", prop_missing_pop_1981, "% de la population en 1981.")

rm(dependent_variable, excluded_covariables, regression_formula)
```

```{r}
dependent_variable <- "GD_ratio_T1"
excluded_covariables <- c("dep", "codecommune", "plm", "abs", "nulsT2", "absT2", "codecommune2", "dep2", "part", "partT2", "GD_ratio_T1", "GD_ratio_T2", "lib_ratio_T1")
regression_formula <- as.formula(paste(dependent_variable, "~", paste(setdiff(names(pres1981), excluded_covariables), collapse = "+")))
model <- lm(regression_formula, data = pres1981)
summary(model)

prop_missing_communes_1981 <- 100 * sum(apply(pres1981[, !excluded_covariables, with = FALSE], 1, function(row) any(is.na(row)))) / nb_communes
rows_with_nan <- pres1981[apply(pres1981[, !excluded_covariables, with = FALSE], 1, function(row) any(is.na(row))), ]
prop_missing_pop_1981 <- 100 * sum(rows_with_nan$pop1981, na.rm = TRUE) / pop_tot_1981
cat("Les valeurs manquantes représentent", prop_missing_communes_1981, "% des communes et", prop_missing_pop_1981, "% de la population en 1981.")

rm(dependent_variable, excluded_covariables, regression_formula)
```
